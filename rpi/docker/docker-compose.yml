services:
  # ============ REVERSE PROXY (DNS ROUTING) ============
  caddy:
    image: caddy:latest
    container_name: meshnet-caddy
    environment:
      - ACME_AGREE=true
    ports:
      - "80:80"
      - "443:443"
    networks:
      - meshnet-network
    restart: unless-stopped
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile
      - ./caddy/data:/data
      - ./caddy/config:/config
    depends_on:
      - webserver
      - backend

  # ============ BACKEND API ============
  backend:
    build:
      context: ../backend
      dockerfile: ../docker/Dockerfile.backend
    container_name: meshnet-backend
    environment:
      - NODE_ENV=production
      - PORT=3001
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_USER=meshnet
      - DB_PASSWORD=meshnet_secure_pwd
      - DB_NAME=meshnet
    ports:
      - "3001:3001"
    depends_on:
      - mysql
    networks:
      - meshnet-network
    restart: unless-stopped
    volumes:
      - ./backend/data:/app/data
      - /dev:/dev  # USB access for bridge

  # ============ WEBSERVER/DASHBOARD ============
  webserver:
    build:
      context: ../webserver
      dockerfile: ../docker/Dockerfile.webserver
    container_name: ghostnet_web
    environment:
      - NODE_ENV=production
      - PORT=80
      - API_URL=http://backend:3001
      - DEBUG=false
    ports:
      - "8080:80"
    depends_on:
      - backend
    networks:
      - meshnet-network
    restart: unless-stopped
    volumes:
      - ./webserver/public/pages:/app/public/pages

  # ============ DATABASE ============
  mysql:
    image: mysql:8.0
    container_name: meshnet-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=root_secure_pwd
      - MYSQL_DATABASE=meshnet
      - MYSQL_USER=meshnet
      - MYSQL_PASSWORD=meshnet_secure_pwd
    ports:
      - "3307:3306"
    networks:
      - meshnet-network
    restart: unless-stopped
    volumes:
      - ./mysql/data:/var/lib/mysql
      - ./mysql.sql:/docker-entrypoint-initdb.d/init.sql

  # ============ OPTIONAL: MQTT BROKER ============
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: meshnet-mqtt
    ports:
      - "1883:1883"
    networks:
      - meshnet-network
    restart: unless-stopped
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data

  # ============ LORA GATEWAY BRIDGE ============
  lora-gateway:
    build:
      context: ../lora-gateway
      dockerfile: ../docker/Dockerfile.lora-gateway
    container_name: meshnet-lora-gateway
    environment:
      - NODE_ENV=production
      - PORT=3002
      - BACKEND_URL=http://backend:3001
      - SERIAL_PORT=${SERIAL_PORT:-}
      - SERIAL_BAUD=${SERIAL_BAUD:-115200}
    ports:
      - "3002:3002"
    depends_on:
      - backend
    networks:
      - meshnet-network
    restart: unless-stopped
    volumes:
      - /dev:/dev  # USB access to Heltec device (read/write)

networks:
  meshnet-network:
    driver: bridge
