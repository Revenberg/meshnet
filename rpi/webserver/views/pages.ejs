<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Management - MeshNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="light-theme">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">üåê MeshNet Dashboard</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/nodes">Nodes</a></li>
                    <li class="nav-item"><a class="nav-link" href="/users">Users</a></li>
                    <li class="nav-item"><a class="nav-link" href="/groups">Groups</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/pages">Pages</a></li>
                    <li class="nav-item"><a class="nav-link" href="/broadcast">üì§ Broadcast</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            üë§ <%= user ? user.username : 'User' %>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/logout">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <% if (error) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <%= error %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <% } %>

        <div class="page-header">
            <h2>Page Management</h2>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="syncPages()">üîÅ Sync Pages</button>
                <button class="btn btn-outline-secondary" onclick="ensureDefaultPages()">üîÑ Add Missing Pages</button>
                <button class="btn btn-primary" onclick="openAddPageModal()">+ Add Page</button>
            </div>
        </div>

        <div class="section">
            <h3>All Pages</h3>
            <% if (pages && pages.length > 0) { %>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Node</th>
                            <th>Content Type</th>
                            <th>Status</th>
                            <th>Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% pages.forEach(page => { %>
                            <tr>
                                <td><strong><%= page.title %></strong></td>
                                <td><span class="badge bg-info"><%= nodeMap[page.nodeId] || 'Global' %></span></td>
                                <td>
                                    <% 
                                        const types = {
                                            'text': 'Text',
                                            'image': 'Image',
                                            'animation': 'Animation',
                                            'status': 'Status'
                                        };
                                    %>
                                    <%= types[page.contentType] || 'Mixed' %>
                                </td>
                                <td>
                                    <span class="badge <%= page.isActive ? 'bg-success' : 'bg-secondary' %>">
                                        <%= page.isActive ? 'Active' : 'Disabled' %>
                                    </span>
                                </td>
                                <td><small><%= new Date(page.updatedAt).toLocaleDateString() %></small></td>
                                <td>
                                    <button class="btn btn-sm btn-primary" data-page-id="<%= page.pageId %>" onclick="editPage(this)">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deletePage('<%= page.pageId %>')">Delete</button>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            <% } else { %>
                <div class="alert alert-info">
                    <p>No pages found. <a href="#" onclick="openAddPageModal()">Create one now</a></p>
                </div>
            <% } %>
        </div>
    </div>

    <!-- Add/Edit Page Modal -->
    <div id="pageModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Page</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="pageForm">
                        <div class="mb-3">
                            <label for="pageTitle" class="form-label">Page Title *</label>
                            <input type="text" class="form-control" id="pageTitle" required>
                        </div>

                        <div class="mb-3">
                            <label for="pageContent" class="form-label">Content *</label>
                            <textarea class="form-control" id="pageContent" rows="6" placeholder="Enter page content..." required></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="contentType" class="form-label">Content Type</label>
                            <select class="form-select" id="contentType">
                                <option value="text">Text</option>
                                <option value="image">Image</option>
                                <option value="animation">Animation</option>
                                <option value="status">Status Display</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="targetNode" class="form-label">Target Node (Optional)</label>
                            <select class="form-select" id="targetNode">
                                <option value="">Global (All Nodes)</option>
                                <% nodes.forEach(node => { %>
                                    <option value="<%= node.nodeId %>"><%= node.nodeName %> (<%= node.nodeId %>)</option>
                                <% }); %>
                            </select>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isActive" checked>
                            <label class="form-check-label" for="isActive">Active</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePage()">Create Page</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script id="pages-data" type="application/json"><%- JSON.stringify(pages || []) %></script>
    <script>
        let currentPageId = null;
        let pageModal = null;
        let allPages = [];

        document.addEventListener('DOMContentLoaded', function() {
            // Load pages from the data script tag
            const pagesData = document.getElementById('pages-data');
            if (pagesData) {
                try {
                    allPages = JSON.parse(pagesData.textContent);
                } catch (e) {
                    console.error('Failed to parse pages data:', e);
                }
            }
            console.log('Loaded pages:', allPages);
            
            // Initialize modal with proper options
            const modalElement = document.getElementById('pageModal');
            if (modalElement) {
                pageModal = new bootstrap.Modal(modalElement, {
                    backdrop: true,
                    keyboard: true
                });
                console.log('Modal initialized successfully');
            } else {
                console.error('Modal element not found!');
            }
        });

        function openAddPageModal() {
            currentPageId = null;
            document.getElementById('pageForm').reset();
            document.querySelector('#pageModal .modal-title').textContent = 'Add Page';
            document.querySelector('#pageModal .btn-primary').textContent = 'Create Page';
            pageModal.show();
        }

        async function ensureDefaultPages() {
            try {
                const response = await axios.post('/api/pages/ensure-defaults');
                const created = response?.data?.created ?? 0;
                alert(`Missing pages created: ${created}`);
                window.location.reload();
            } catch (error) {
                console.error('Failed to ensure default pages:', error);
                alert('Failed to add missing pages.');
            }
        }

        async function syncPages() {
            try {
                await axios.post('/api/sync/push/pages');
                alert('Pages sync pushed to Heltec nodes.');
            } catch (error) {
                console.error('Failed to sync pages:', error);
                alert('Failed to sync pages.');
            }
        }

        function editPage(button) {
            const pageId = button.getAttribute('data-page-id');
            console.log('Edit clicked with pageId:', pageId);
            console.log('AllPages array:', allPages);
            
            currentPageId = pageId;
            
            // Find the page in the allPages array
            const page = allPages.find(p => {
                console.log('Comparing pageIds:', p.pageId, '===', pageId);
                return String(p.pageId) === String(pageId);
            });
            
            console.log('Found page:', page);
            
            if (!page) {
                alert('Page not found: ' + pageId);
                return;
            }
            
            // Populate form with page data
            document.getElementById('pageTitle').value = page.title || '';
            document.getElementById('pageContent').value = page.content || '';
            document.getElementById('contentType').value = page.contentType || 'text';
            document.getElementById('targetNode').value = page.nodeId || '';
            document.getElementById('isActive').checked = page.isActive;
            
            // Update modal header
            document.querySelector('#pageModal .modal-title').textContent = 'Edit Page';
            document.querySelector('#pageModal .btn-primary').textContent = 'Save Changes';
            pageModal.show();
        }

        function savePage() {
            const title = document.getElementById('pageTitle').value;
            const content = document.getElementById('pageContent').value;
            const contentType = document.getElementById('contentType').value;
            const nodeId = document.getElementById('targetNode').value;
            const isActive = document.getElementById('isActive').checked;
            
            if (!title || !content) {
                alert('Please fill in all required fields');
                return;
            }
            
            const pageData = {
                title,
                content,
                contentType,
                nodeId: nodeId || null,
                isActive
            };
            
            const url = currentPageId ? `/api/pages/${currentPageId}` : '/api/pages';
            const method = currentPageId ? 'PUT' : 'POST';
            
            axios({
                method: method,
                url: url,
                data: pageData,
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                pageModal.hide();
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving page: ' + (error.response?.data?.error || error.message));
            });
        }

        function deletePage(pageId) {
            if (confirm('Are you sure you want to delete this page?')) {
                axios.delete(`/api/pages/${pageId}`)
                    .then(response => {
                        location.reload();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error deleting page: ' + (error.response?.data?.error || error.message));
                    });
            }
        }
    </script>

    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .page-header h2 {
            margin: 0;
        }

        .section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .badge {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Modal styling */
        .modal {
            z-index: 1050 !important;
        }

        .modal-backdrop {
            z-index: 1040 !important;
        }

        .modal.show {
            display: block !important;
        }

        .modal-dialog {
            position: relative;
            z-index: 1050 !important;
        }
    </style>
</body>
</html>
