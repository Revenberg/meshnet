<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - MeshNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="light-theme">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">üåê MeshNet Dashboard</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/nodes">Nodes</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/users">Users</a></li>
                    <li class="nav-item"><a class="nav-link" href="/groups">Groups</a></li>
                    <li class="nav-item"><a class="nav-link" href="/pages">Pages</a></li>
                    <li class="nav-item"><a class="nav-link" href="/broadcast">üì§ Broadcast</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            üë§ <%= user ? user.username : 'User' %>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/logout">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <% if (error) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <%= error %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <% } %>

<div class="page-header">
  <h2>User Management</h2>
  <button class="btn btn-primary" onclick="openAddUserModal()">+ Add User</button>
</div>

<div class="section">
  <h3>All Users</h3>
  <% if (users && users.length > 0) { %>
    <table class="table">
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Group</th>
          <th>Status</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% users.forEach(user => { %>
          <tr>
            <td><strong><%= user.username %></strong></td>
            <td><%= user.email %></td>
            <td><span class="badge"><%= groupMap ? groupMap[user.groupId] : 'Unknown' %></span></td>
            <td>
              <span class="status-badge status-<%= user.isActive ? 'active' : 'inactive' %>">
                <%= user.isActive ? 'Active' : 'Inactive' %>
              </span>
            </td>
            <td><small><%= new Date(user.createdAt).toLocaleDateString() %></small></td>
            <td>
              <button class="btn btn-small btn-primary" onclick="editUser('<%= user.userId %>', '<%= user.username %>', '<%= user.email %>', <%= user.groupId %>)">Edit</button>
              <button class="btn btn-small btn-danger" onclick="deleteUser('<%= user.userId %>')">Delete</button>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  <% } else { %>
    <div class="empty-state">
      <p>No users found</p>
    </div>
  <% } %>
</div>

<!-- Add/Edit User Modal -->
<div id="userModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Add User</h2>
    </div>
    <div class="modal-body">
      <form id="userForm">
        <input type="hidden" id="userId" name="userId">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" name="username" required>
        </div>
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" required>
          <small id="passwordHint" style="display: none; color: var(--color-info);">Leave blank to keep current password</small>
        </div>
        <div class="form-group">
          <label for="groupId">Group</label>
          <select id="groupId" name="groupId" required>
            <option value="">Select Group</option>
            <% groups.forEach(group => { %>
              <option value="<%= group.id %>"><%= group.name %></option>
            <% }); %>
          </select>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
      <button class="btn btn-primary" id="saveBtn" onclick="saveUser()">Create User</button>
    </div>
  </div>
</div>

<style scoped>
.badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  background: var(--color-info);
  color: white;
  border-radius: 4px;
  font-size: 0.85rem;
  font-weight: bold;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.page-header h2 {
  margin: 0;
}
</style>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/client.js"></script>

<script>
function openAddUserModal() {
  document.getElementById('userForm').reset();
  document.getElementById('userId').value = '';
  document.getElementById('modalTitle').textContent = 'Add User';
  document.getElementById('saveBtn').textContent = 'Create User';
  document.getElementById('password').required = true;
  document.getElementById('passwordHint').style.display = 'none';
  document.getElementById('userModal').classList.add('show');
}

function closeModal(modalId) {
  document.getElementById(modalId).classList.remove('show');
}

async function saveUser() {
  const userId = document.getElementById('userId').value;
  const username = document.getElementById('username').value;
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  const groupId = document.getElementById('groupId').value;

  if (!username || !email || !groupId) {
    alert('Please fill in all required fields');
    return;
  }

  // For new users, password is required. For edits, it's optional
  if (!userId && !password) {
    alert('Password is required for new users');
    return;
  }

  try {
    let response;
    if (userId) {
      // Update existing user
      const updateData = {
        username,
        email,
        groupId: parseInt(groupId)
      };
      // Only include password if provided
      if (password) {
        updateData.password = password;
      }
      response = await axios.put(`/api/users/${userId}`, updateData);
      if (response.data.success) {
        closeModal('userModal');
        location.reload();
      }
    } else {
      // Create new user
      response = await axios.post('/api/users', {
        username,
        email,
        password,
        groupId: parseInt(groupId)
      });
      if (response.data.success || response.data.userId || response.data.status === 'created') {
        closeModal('userModal');
        location.reload();
      }
    }
  } catch (error) {
    console.error('Error saving user:', error);
  }
}

function editUser(userId, username, email, groupId) {
  document.getElementById('userId').value = userId;
  document.getElementById('username').value = username;
  document.getElementById('email').value = email;
  document.getElementById('groupId').value = groupId;
  document.getElementById('password').value = '';
  document.getElementById('password').required = false;
  document.getElementById('modalTitle').textContent = 'Edit User';
  document.getElementById('saveBtn').textContent = 'Update User';
  document.getElementById('passwordHint').style.display = 'block';
  document.getElementById('userModal').classList.add('show');
}

async function deleteUser(userId) {
  if (confirm('Are you sure you want to delete this user?')) {
    try {
      const response = await axios.delete(`/api/users/${userId}`);
      if (response.data.success) {
        location.reload();
      }
    } catch (error) {
      console.error('Error deleting user:', error);
    }
  }
}
</script>
</body>
</html>
