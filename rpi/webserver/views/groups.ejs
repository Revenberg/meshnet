<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Management - MeshNet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="light-theme">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">üåê MeshNet Dashboard</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/nodes">Nodes</a></li>
                    <li class="nav-item"><a class="nav-link" href="/users">Users</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/groups">Groups</a></li>
                    <li class="nav-item"><a class="nav-link" href="/pages">Pages</a></li>
                    <li class="nav-item"><a class="nav-link" href="/broadcast">üì§ Broadcast</a></li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            üë§ <%= user ? user.username : 'User' %>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/logout">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Filter/Selection Bar -->
    <div class="bg-light border-bottom py-2 mb-4">
        <div class="container-fluid">
            <div class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label">Sort Groups by:</label>
                    <select id="sortFilter" class="form-select" onchange="sortGroups()">
                        <option value="name">Name (A-Z)</option>
                        <option value="members">Members (High to Low)</option>
                        <option value="created">Recently Created</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Search Groups:</label>
                    <input type="text" id="groupSearch" class="form-control" placeholder="Search by group name..." onkeyup="searchGroups()">
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <% if (error) { %>
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <%= error %>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        <% } %>

<div class="page-header">
  <h2>Group Management</h2>
  <button class="btn btn-primary" onclick="openAddGroupModal()">+ Add Group</button>
</div>

<div class="section">
  <h3>All Groups</h3>
  <% if (groups && groups.length > 0) { %>
    <table class="table">
      <thead>
        <tr>
          <th>Group Name</th>
          <th>Members</th>
          <th>Permissions</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% groups.forEach(group => { %>
          <tr>
            <td><strong><%= group.name %></strong></td>
            <td><span class="badge badge-info"><%= group.memberCount || 0 %></span></td>
            <td>
              <% 
                let permCount = 0;
                try {
                  let perms = group.permissions;
                  // Check if it's a string that needs parsing
                  if (typeof perms === 'string') {
                    perms = JSON.parse(perms || '{}');
                  }
                  // Count permissions
                  if (Array.isArray(perms)) {
                    permCount = perms.length;
                  } else if (typeof perms === 'object' && perms !== null) {
                    permCount = Object.values(perms).filter(v => v === true).length;
                  }
                } catch(e) {
                  permCount = 0;
                }
              %>
              <small><%= permCount %> permissions granted</small>
            </td>
            <td><small><%= new Date(group.createdAt).toLocaleDateString() %></small></td>
            <td>
              <button class="btn btn-small btn-primary" onclick="editGroupData(this)" data-id="<%= group.id %>" data-name="<%= group.name %>" data-permissions="<%= JSON.stringify(group.permissions || {}) %>">Edit</button>
              <button class="btn btn-small btn-danger" onclick="deleteGroup('<%= group.id %>')">Delete</button>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  <% } else { %>
    <div class="empty-state">
      <p>No groups found</p>
    </div>
  <% } %>
</div>

<!-- Add/Edit Group Modal -->
<div id="groupModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="groupModalTitle">Add Group</h2>
    </div>
    <div class="modal-body">
      <form id="groupForm">
        <input type="hidden" id="groupId" name="groupId">
        <div class="form-group">
          <label for="groupName">Group Name</label>
          <input type="text" id="groupName" name="groupName" required>
        </div>
        
        <fieldset>
          <legend>Permissions</legend>
          <div class="checkbox-group">
            <label><input type="checkbox" name="perm_nodes_read"> Read Nodes</label>
            <label><input type="checkbox" name="perm_nodes_write"> Manage Nodes</label>
            <label><input type="checkbox" name="perm_users_read"> Read Users</label>
            <label><input type="checkbox" name="perm_users_write"> Manage Users</label>
            <label><input type="checkbox" name="perm_groups_write"> Manage Groups</label>
            <label><input type="checkbox" name="perm_pages_write"> Manage Pages</label>
            <label><input type="checkbox" name="perm_broadcast"> Send Broadcast</label>
            <label><input type="checkbox" name="perm_monitor"> View Monitoring</label>
            <label><input type="checkbox" name="perm_admin"> Admin Access</label>
          </div>
        </fieldset>
      </form>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeGroupModal()">Cancel</button>
      <button class="btn btn-primary" id="groupSaveBtn" onclick="saveGroup()">Create Group</button>
    </div>
  </div>
</div>

<style scoped>
.badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  background: var(--color-info);
  color: white;
  border-radius: 4px;
  font-size: 0.85rem;
  font-weight: bold;
}

.badge-info {
  background: #667eea;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
}

.page-header h2 {
  margin: 0;
}

.checkbox-group {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
}

.checkbox-group label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
}

.checkbox-group input {
  cursor: pointer;
}

fieldset {
  border: 1px solid var(--color-border);
  padding: 1rem;
  border-radius: 4px;
}

legend {
  padding: 0 0.5rem;
  font-weight: bold;
}
</style>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/client.js"></script>

<script>
function openAddGroupModal() {
  document.getElementById('groupId').value = '';
  document.getElementById('groupForm').reset();
  document.getElementById('groupModalTitle').textContent = 'Add Group';
  document.getElementById('groupSaveBtn').textContent = 'Create Group';
  document.getElementById('groupModal').classList.add('show');
}

function closeGroupModal() {
  document.getElementById('groupModal').classList.remove('show');
}

// Wrapper function to read data attributes
function editGroupData(button) {
  const groupId = button.getAttribute('data-id');
  const name = button.getAttribute('data-name');
  const permissionsJson = button.getAttribute('data-permissions');
  let permissions = {};
  try {
    permissions = JSON.parse(permissionsJson);
  } catch (e) {
    console.error('Error parsing permissions:', e);
  }
  editGroup(groupId, name, permissions);
}

async function saveGroup() {
  const groupId = document.getElementById('groupId').value;
  const name = document.getElementById('groupName').value;
  
  if (!name) {
    alert('Please enter a group name');
    return;
  }

  // Collect permissions
  const permissions = {
    perm_nodes_read: document.querySelector('input[name="perm_nodes_read"]').checked,
    perm_nodes_write: document.querySelector('input[name="perm_nodes_write"]').checked,
    perm_users_read: document.querySelector('input[name="perm_users_read"]').checked,
    perm_users_write: document.querySelector('input[name="perm_users_write"]').checked,
    perm_groups_write: document.querySelector('input[name="perm_groups_write"]').checked,
    perm_pages_write: document.querySelector('input[name="perm_pages_write"]').checked,
    perm_broadcast: document.querySelector('input[name="perm_broadcast"]').checked,
    perm_monitor: document.querySelector('input[name="perm_monitor"]').checked,
    perm_admin: document.querySelector('input[name="perm_admin"]').checked
  };

  try {
    let response;
    
    if (groupId) {
      // Update existing group
      response = await axios.put(`/api/groups/${groupId}`, {
        name,
        description: `${name} group`,
        permissions
      });

      if (response.data.success || response.data.status === 'updated') {
        closeGroupModal();
        location.reload();
      }
    } else {
      // Create new group
      response = await axios.post('/api/groups', {
        name,
        description: `${name} group`,
        permissions
      });

      if (response.data.status === 'created') {
        closeGroupModal();
        location.reload();
      }
    }
  } catch (error) {
    console.error('Error saving group:', error);
  }
}

function editGroup(groupId, name, permissions) {
  document.getElementById('groupId').value = groupId;
  document.getElementById('groupName').value = name;
  
  // Update modal title and button
  document.getElementById('groupModalTitle').textContent = 'Edit Group';
  document.getElementById('groupSaveBtn').textContent = 'Update Group';
  
  // Reset all checkboxes first
  document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
    checkbox.checked = false;
  });
  
  // Set permission checkboxes - handle both object and array formats
  if (permissions && typeof permissions === 'object') {
    if (Array.isArray(permissions)) {
      // Handle array format - treat array items as permission names
      permissions.forEach(perm => {
        // Map common permission names to our checkboxes
        if (perm === 'manage_groups' || perm === 'ALL') document.querySelector('input[name="perm_groups_write"]').checked = true;
        if (perm === 'manage_users' || perm === 'ALL') document.querySelector('input[name="perm_users_write"]').checked = true;
        if (perm === 'view_users' || perm === 'ALL') document.querySelector('input[name="perm_users_read"]').checked = true;
        if (perm === 'edit_nodes' || perm === 'manage_nodes' || perm === 'ALL') document.querySelector('input[name="perm_nodes_write"]').checked = true;
        if (perm === 'view_nodes' || perm === 'ALL') document.querySelector('input[name="perm_nodes_read"]').checked = true;
        if (perm === 'edit_pages' || perm === 'manage_pages' || perm === 'ALL') document.querySelector('input[name="perm_pages_write"]').checked = true;
        if (perm === 'view_logs' || perm === 'monitor' || perm === 'ALL') document.querySelector('input[name="perm_monitor"]').checked = true;
        if (perm === 'system_admin' || perm === 'admin' || perm === 'ALL') document.querySelector('input[name="perm_admin"]').checked = true;
      });
    } else {
      // Handle object format - direct property mapping
      document.querySelector('input[name="perm_nodes_read"]').checked = permissions.perm_nodes_read || false;
      document.querySelector('input[name="perm_nodes_write"]').checked = permissions.perm_nodes_write || false;
      document.querySelector('input[name="perm_users_read"]').checked = permissions.perm_users_read || false;
      document.querySelector('input[name="perm_users_write"]').checked = permissions.perm_users_write || false;
      document.querySelector('input[name="perm_groups_write"]').checked = permissions.perm_groups_write || false;
      document.querySelector('input[name="perm_pages_write"]').checked = permissions.perm_pages_write || false;
      document.querySelector('input[name="perm_broadcast"]').checked = permissions.perm_broadcast || false;
      document.querySelector('input[name="perm_monitor"]').checked = permissions.perm_monitor || false;
      document.querySelector('input[name="perm_admin"]').checked = permissions.perm_admin || false;
    }
  }
  
  document.getElementById('groupModal').classList.add('show');
}

async function deleteGroup(groupId) {
  if (confirm('Are you sure you want to delete this group?')) {
    try {
      const response = await axios.delete(`/api/groups/${groupId}`);
      if (response.data.success) {
        location.reload();
      }
    } catch (error) {
      console.error('Error deleting group:', error);
    }
  }
}

function sortGroups() {
  const sort = document.getElementById('sortFilter').value;
  window.location.href = `/groups?sort=${sort}`;
}

function searchGroups() {
  const query = document.getElementById('groupSearch').value.toLowerCase();
  if (query.length > 0) {
    window.location.href = `/groups?search=${encodeURIComponent(query)}`;
  } else {
    window.location.href = '/groups';
  }
}
</script>
</body>
</html>
